<!DOCTYPE html>
<html class="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Health Assistant</title>

  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>

  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#4A90E2",
            "background-light": "#F9F9F9",
            "background-dark": "#101922",
            "chatbot-bubble": "#EFEFEF",
            "text-light": "#111418",
            "text-dark": "#F9F9F9",
            "text-secondary-light": "#617589",
            "text-secondary-dark": "#a0aec0",
          },
          fontFamily: {
            display: ["Inter", "sans-serif"],
          },
        },
      },
    };
  </script>

  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
    }
    .chat-scroll { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex h-screen w-full flex-col overflow-hidden">
  <div class="flex h-full grow">
    <main class="flex flex-1 flex-col h-screen bg-background-light dark:bg-background-dark">

      <!-- HEADER -->
      <header class="flex items-center justify-between border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-background-dark px-6 py-4">
        <div class="flex items-center gap-4">
          <h2 class="text-text-light dark:text-text-dark text-lg font-bold tracking-[-0.015em]">
            AI Health Assistant
          </h2>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500"></div>
            <p class="text-sm text-green-600 dark:text-green-400 font-medium">
              Connected to backend
            </p>
          </div>
        </div>
        <div class="flex gap-2 items-center">
          <button id="themeToggle"
                  class="flex items-center cursor-pointer justify-center rounded-lg h-10 px-3 bg-gray-100 dark:bg-gray-700 text-text-light dark:text-text-dark text-sm font-medium">
            <span class="material-symbols-outlined text-xl mr-1">dark_mode</span>
            <span id="themeLabel">Dark</span>
          </button>
          <button id="refreshChat"
                  class="flex cursor-pointer items-center justify-center rounded-lg h-10 bg-gray-100 dark:bg-gray-700 text-text-light dark:text-text-dark px-2.5">
            <span class="material-symbols-outlined text-xl">refresh</span>
          </button>
        </div>
      </header>

      <!-- CHAT AREA -->
      <div id="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-6 chat-scroll">
        <div class="flex items-end gap-3 max-w-xl">
          <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-primary text-white">
            <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <path d="M7 15C7.66667 12.6667 9.6 11 12 11C14.4 11 16.3333 12.6667 17 15"
                    stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
              <circle cx="9" cy="9" r="1.5"
                      stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></circle>
              <circle cx="15" cy="9" r="1.5"
                      stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></circle>
            </svg>
          </div>
          <div class="flex flex-1 flex-col gap-1 items-start">
            <p class="text-base leading-relaxed flex max-w-lg rounded-xl rounded-bl-none px-4 py-3 bg-chatbot-bubble text-text-light dark:bg-gray-700 dark:text-text-dark">
              Hi! Describe your symptoms and I will generate a chatbot reply, predict possible disease and list some reference medicines.
            </p>
            <p class="text-text-secondary-light dark:text-text-secondary-dark text-xs px-1">
              Ready
            </p>
          </div>
        </div>
      </div>

      <!-- INPUT AREA -->
      <div class="bg-white dark:bg-background-dark border-t border-gray-200 dark:border-gray-700 p-4">
        <div class="relative">
          <textarea
            id="symptomInput"
            class="w-full resize-none rounded-lg border border-gray-300 dark:border-gray-600 bg-background-light dark:bg-gray-700 py-3 pl-4 pr-14 text-base text-text-light dark:text-text-dark placeholder:text-text-secondary-light dark:placeholder:text-text-secondary-dark focus:border-primary focus:ring-primary"
            placeholder="Enter your symptoms..."
            rows="1"
          ></textarea>

          <button
            id="sendBtn"
            class="absolute right-3 top-1/2 -translate-y-1/2 flex h-8 w-8 cursor-pointer items-center justify-center rounded-full bg-primary text-white hover:bg-primary/90 disabled:bg-gray-300 dark:disabled:bg-gray-600"
          >
            <span class="material-symbols-outlined text-xl">send</span>
          </button>
        </div>

        <!-- Can be hidden later; now just keeps raw text log -->
        <pre
          id="chatOutput" -->
          class="mt-3 w-full rounded-lg bg-black/5 dark:bg-white/5 text-xs md:text-sm text-text-light dark:text-text-dark p-3 whitespace-pre-wrap overflow-x-auto"
        ></pre>

        <p class="text-center text-xs text-text-secondary-light dark:text-text-secondary-dark mt-2">
          This tool is for educational purposes only and is not a substitute for professional medical advice.
        </p>
      </div>
    </main>
  </div>
</div>

<script>
  const input       = document.getElementById("symptomInput");
  const output      = document.getElementById("chatOutput");
  const sendBtn     = document.getElementById("sendBtn");
  const chatContainer = document.getElementById("chatContainer");
  const themeToggle = document.getElementById("themeToggle");
  const themeLabel  = document.getElementById("themeLabel");
  const refreshChat = document.getElementById("refreshChat");

  function autoResize() {
    input.style.height = "auto";
    input.style.height = input.scrollHeight + "px";
  }
  input.addEventListener("input", autoResize);

  function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }

  function addUserBubble(text) {
    const time = getCurrentTime();
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-end gap-3 justify-end";
    wrapper.innerHTML = `
      <div class="flex flex-1 flex-col gap-1 items-end">
        <p class="text-base leading-relaxed flex max-w-lg rounded-xl rounded-br-none px-4 py-3 bg-primary text-white">
          ${text}
        </p>
        <p class="text-text-secondary-light dark:text-text-secondary-dark text-xs px-1">${time}</p>
      </div>
      <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0"
           style="background-image:url('https://lh3.googleusercontent.com/a-/dummyUser');"></div>
    `;
    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function addBotBubbleFromTextBlock(textBlock) {
    // Convert line breaks into <br> for nice formatting in bubble
    const safeHtml = textBlock
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\n/g, "<br>");

    const time = getCurrentTime();
    const wrapper = document.createElement("div");
    wrapper.className = "flex items-end gap-3 max-w-xl";
    wrapper.innerHTML = `
      <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-primary text-white">
        <svg fill="none" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2Z"
                stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          <path d="M7 15C7.66667 12.6667 9.6 11 12 11C14.4 11 16.3333 12.6667 17 15"
                stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
          <circle cx="9" cy="9" r="1.5"
                  stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></circle>
          <circle cx="15" cy="9" r="1.5"
                  stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></circle>
        </svg>
      </div>
      <div class="flex flex-1 flex-col gap-1 items-start">
        <p class="text-sm md:text-base leading-relaxed flex max-w-3xl rounded-xl rounded-bl-none px-4 py-3 bg-chatbot-bubble text-text-light dark:bg-gray-700 dark:text-text-dark">
          ${safeHtml}
        </p>
        <p class="text-text-secondary-light dark:text-text-secondary-dark text-xs px-1">${time}</p>
      </div>
    `;
    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function addTypingIndicator() {
    const wrapper = document.createElement("div");
    wrapper.id = "typingIndicator";
    wrapper.className = "flex items-end gap-3 max-w-xl";
    wrapper.innerHTML = `
      <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full bg-primary text-white">
        <span class="material-symbols-outlined text-xl">smart_toy</span>
      </div>
      <div class="flex items-center gap-1.5 rounded-xl rounded-bl-none px-4 py-3 bg-chatbot-bubble text-text-light dark:bg-gray-700 dark:text-text-dark">
        <span class="w-2 h-2 bg-text-secondary-light dark:bg-text-secondary-dark rounded-full animate-pulse [animation-delay:-0.3s]"></span>
        <span class="w-2 h-2 bg-text-secondary-light dark:bg-text-secondary-dark rounded-full animate-pulse [animation-delay:-0.15s]"></span>
        <span class="w-2 h-2 bg-text-secondary-light dark:bg-text-secondary-dark rounded-full animate-pulse"></span>
      </div>
    `;
    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function removeTypingIndicator() {
    const t = document.getElementById("typingIndicator");
    if (t) t.remove();
  }

  async function callChatApi(symptoms) {
    const res = await fetch("http://127.0.0.1:5000/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symptoms })
    });
    return res.json();
  }

  async function callDiseaseApi(symptoms) {
    const res = await fetch("http://127.0.0.1:5000/api/predict_disease", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symptoms })
    });
    return res.json();
  }

  async function callMedicineApi(symptoms) {
    const res = await fetch("http://127.0.0.1:5000/api/recommend_medicines", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ symptoms, topk: 3 })
    });
    return res.json();
  }

  sendBtn.addEventListener("click", async () => {
    const symptoms = input.value.trim();
    if (!symptoms) {
      alert("Please enter symptoms");
      return;
    }

    addUserBubble(symptoms);
    input.value = "";
    autoResize();

    output.textContent = "Analyzing...";
    addTypingIndicator();

    try {
      const [chatResp, disease, meds] = await Promise.all([
        callChatApi(symptoms),
        callDiseaseApi(symptoms),
        callMedicineApi(symptoms)
      ]);

      removeTypingIndicator();

      let txt = "";
      // chatbot part
      if (chatResp && chatResp.message) {
        txt += "Chatbot answer:\n";
        txt += chatResp.message + "\n\n";
      } else if (chatResp && chatResp.error) {
        txt += "Chatbot error: " + chatResp.error + "\n\n";
      }

      // disease part
      if (disease && !disease.error) {
        txt += `Predicted disease: ${disease.prediction}\n`;
        txt += `Description: ${disease.description}\n`;
        if (Array.isArray(disease.precautions)) {
          txt += `Precautions: ${disease.precautions.join(", ")}\n\n`;
        } else if (disease.precautions) {
          txt += `Precautions: ${disease.precautions}\n\n`;
        } else {
          txt += "Precautions: No data\n\n";
        }
      } else if (disease && disease.error) {
        txt += "Disease API error: " + disease.error + "\n\n";
      }

      // medicine part
      if (meds && !meds.error && Array.isArray(meds.medicines)) {
        txt += "Medicines:\n";
        meds.medicines.forEach((m, i) => {
          txt += `${i + 1}. ${m.Name} (${m["Dosage Form"]})\n`;
        });
      } else if (meds && meds.error) {
        txt += "Medicine API error: " + meds.error + "\n";
      }

      if (!txt) txt = "No data received from backend.";

      // show in small log area
      output.textContent = txt;
      // also as nice bot bubble
      addBotBubbleFromTextBlock(txt);

    } catch (e) {
      console.error(e);
      removeTypingIndicator();
      output.textContent = "Error calling backend.";
      addBotBubbleFromTextBlock("There was an error contacting the backend. Please check if the Flask server is running.");
    }
  });

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendBtn.click();
    }
  });

  function setTheme(mode) {
    const html = document.documentElement;
    if (mode === "dark") {
      html.classList.add("dark");
      themeLabel.textContent = "Light";
      localStorage.setItem("theme", "dark");
    } else {
      html.classList.remove("dark");
      themeLabel.textContent = "Dark";
      localStorage.setItem("theme", "light");
    }
  }
  const saved = localStorage.getItem("theme") || "light";
  setTheme(saved);

  themeToggle.addEventListener("click", () => {
    const html = document.documentElement;
    setTheme(html.classList.contains("dark") ? "light" : "dark");
  });

  refreshChat.addEventListener("click", () => {
    chatContainer.innerHTML = "";
    output.textContent = "";
  });
</script>
</body>
</html>
